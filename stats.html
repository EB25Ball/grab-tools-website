<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Stats | Grab Tools | twhlynch </title>
    <link rel="stylesheet" href="style.css">
    <!-- favicon gif -->
    <link rel="icon" href="spindex-small.gif" type="image/gif">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BDS57RBQ3Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-BDS57RBQ3Q');
    </script>
</head>
<body>
    <div class="title">Stats - Updated daily
        <a href="index.html" class="home"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
        </svg></a>
    </div>
    <div id="details">
        <input type="text" id="user-input" placeholder="USER">
        <input type="text" id="key-input" placeholder="KEY (split '|')">
        <button id="submit-btn">Submit</button>
        <p id="stats-out"></p>
    </div>
    <script>
        const submitBtn = document.getElementById("submit-btn");
        const idInput = document.getElementById("user-input");
        const keyInput = document.getElementById("key-input");
        const output = document.getElementById("stats-out");
    
        submitBtn.addEventListener("click", async () => {
        const user = idInput.value;
        var id = user;
        if (user) {
            try {
                const userDataResponse = await fetch(`https://api.slin.dev/grab/v1/list?type=user_name&search_term=${user}`);
                const userData = await userDataResponse.json();
                id = userData[0].user_id.toLowerCase();
            } catch {
                
            }
        }
        const keys = keyInput.value.toLowerCase().split("|");

        const promises2 = [
            fetch('stats-data.json'),
        ];
        
        const promises1 = [
            fetch(`https://api.slin.dev/grab/v1/list?max_format_version=7&user_id=${id}`)
        ];

        const responses2 = await Promise.all(promises2);
        const json_data2 = await Promise.all(responses2.map(res => res.json()));
        
        const responses1 = await Promise.all(promises1);
        const json_data1 = await Promise.all(responses1.map(res => res.json()));

        const array1 = json_data1.flat().filter(level => !level.tags || level.tags.ok);

        const array2 = json_data2.flat();

        const array = array1.concat(array2);

        var levels = array.filter(level => {
            for (var key of keys) {
                if (level["title"].toLowerCase().includes(key)) {
                    if (level["identifier"].split(":")[0].toLowerCase().includes(id)) {
                        return true; 
                    }
                }
            }
            return false;
        });

        levels.sort((a, b) => b.statistics.total_played - a.statistics.total_played);

        let total = 0;
        output.innerHTML = "";
        levels.forEach(level => {
            total += level["statistics"]["total_played"];
            output.innerHTML += `${level["title"]}: <b>${level["statistics"]["total_played"]}</b><br>`;
        });

        output.innerHTML += `<b>Total plays: ${total}</b><br>`;
        });
      </script>
</body>
</html>
